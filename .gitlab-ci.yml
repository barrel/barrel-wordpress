stages:
  - test
  - deploy
  - merge_request
image: barrelny/pantheon-ci:0.0.9
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - wp-content/themes/$THEME_NAME/node_modules/
test_build_theme:
  stage: test
  script:
    - cd ./wp-content/themes/$THEME_NAME && npm i
    - npm run build
test_php_syntax:
  stage: test
  script: 
    - git diff --diff-filter=ACMR --name-only origin/master -- '*.php' | xargs -L1 php -d short_open_tag=Off -l
# @todo: install standard globally to CI image
test_js_lint:
  stage: test
  before_script:
    - npm config set loglevel warn && npm set progress=false
    - npm install -g standard --loglevel=warn
    - cd ./wp-content/themes/$THEME_NAME
  script: standard
# @todo: install editorconfig-checker globally to CI image
test_editorconfig:
  stage: test
  before_script:
    - npm config set loglevel warn && npm set progress=false
    - npm i -g editorconfig-checker
    - cd ./wp-content/themes/$THEME_NAME
  script:
    - editorconfig-checker ./**/*
# @todo: install stylelint globally to CI image
test_css_lint:
  stage: test
  before_script:
    - cd ./wp-content/themes/$THEME_NAME && npm i
  script: 
    - npm run test_css_lint
test_modules:
  stage: test
  script: 
    - bash private/scripts/test_modules.sh
multidev_develop:
  only: 
    - develop
  stage: deploy
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - bash private/scripts/import_git_remote.sh
  script:
    - bash private/scripts/multidev_deploy_develop.sh
multidev_feature:
  only: 
    - /^feature\/.*$/
  stage: deploy
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - bash private/scripts/import_git_remote.sh
  script:
    - bash private/scripts/multidev_deploy_feature.sh
multidev_hotfix:
  only:
    - /^hotfix\/.*$/
  stage: deploy
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - bash private/scripts/import_git_remote.sh
  script:
    - bash private/scripts/multidev_deploy_hotfix.sh
create_merge_request:
  stage: merge_request
  only:
    - /^(feature|bugfix|support)\/.*/
  when: manual
  script:
    - ./private/scripts/merge-request.sh
